<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>吃喝探索地圖</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js for Map Display -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine for Path Planning -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <!-- Leaflet Control Geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        .leaflet-routing-container { max-height: 200px; overflow-y: auto; }
        .custom-radio-label {
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .custom-radio-input:checked + .custom-radio-label {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
            font-weight: 600;
        }
        #results-panel::-webkit-scrollbar { width: 6px; }
        #results-panel::-webkit-scrollbar-track { background: #f8fafc; }
        #results-panel::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px;}
        #results-panel::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* Sidebar transition */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

<div class="relative h-screen w-screen bg-gray-50 md:flex">

    <!-- Combined Sidebar for Mobile and Desktop -->
    <div id="sidebar" class="absolute md:relative h-full w-full max-w-md md:w-auto md:max-w-none md:flex transform -translate-x-full md:translate-x-0 bg-white z-20">
        <!-- Left Column: Search Controls -->
        <div class="w-full md:w-auto md:max-w-xs flex flex-col border-r border-gray-200 p-4 space-y-6">
            <header class="text-center">
                <div class="flex justify-between items-center md:justify-center">
                    <h1 class="text-2xl font-bold text-gray-800 text-center">地圖探險家</h1>
                    <button id="close-sidebar-btn" class="p-2 md:hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <p class="text-sm text-gray-500">您的智慧在地嚮導</p>
                <p class="text-xs text-gray-400 mt-2">製作者: 黃建勳</p>
            </header>

            <!-- Location Settings -->
            <div class="space-y-3">
                <h2 class="text-md font-semibold text-gray-700">1. 設定中心點</h2>
                <div class="flex rounded-md shadow-sm">
                    <input type="text" id="search-input" class="flex-1 block w-full rounded-none rounded-l-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2" placeholder="想從哪裡出發？">
                    <button id="search-address-btn" class="inline-flex items-center rounded-r-md border border-l-0 border-gray-300 bg-gray-50 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                 <button id="locate-me-btn" class="w-full inline-flex justify-center items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.25 2.5a.75.75 0 00-1.5 0v.065a5.983 5.983 0 00-4.493 2.11.75.75 0 001.06 1.06A4.484 4.484 0 0110 4a4.5 4.5 0 014.5 4.5c0 1.22-.492 2.32-1.307 3.134a.75.75 0 001.06 1.06A5.983 5.983 0 0016 8.5a6 6 0 00-6-6v-.065a.75.75 0 00-.75-.75z" /><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.25 4.623a6.5 6.5 0 015.635 10.748.75.75 0 00-.97-1.154 5 5 0 10-4.665-9.593.75.75 0 00-.97 1.154A6.473 6.473 0 019.25 4.623z" /></svg>
                    <span>使用我的目前位置</span>
                </button>
            </div>

            <!-- Filters -->
            <div class="space-y-3">
                 <h2 class="text-md font-semibold text-gray-700">2. 篩選條件</h2>
                 <div>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="radio" id="cat-food" name="category" value="food" class="hidden custom-radio-input" checked>
                        <label for="cat-food" class="custom-radio-label text-center p-2 border rounded-md cursor-pointer text-sm">美食</label>
                        <input type="radio" id="cat-cafe" name="category" value="cafe" class="hidden custom-radio-input">
                        <label for="cat-cafe" class="custom-radio-label text-center p-2 border rounded-md cursor-pointer text-sm">咖啡廳</label>
                        <input type="radio" id="cat-drinks" name="category" value="drinks" class="hidden custom-radio-input">
                        <label for="cat-drinks" class="custom-radio-label text-center p-2 border rounded-md cursor-pointer text-sm">手搖飲</label>
                    </div>
                </div>
                <div>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="radio" id="rad-250" name="radius" value="250" class="hidden custom-radio-input">
                        <label for="rad-250" class="custom-radio-label text-center p-2 border rounded-md cursor-pointer text-sm">250m</label>
                        <input type="radio" id="rad-500" name="radius" value="500" class="hidden custom-radio-input" checked>
                        <label for="rad-500" class="custom-radio-label text-center p-2 border rounded-md cursor-pointer text-sm">500m</label>
                        <input type="radio" id="rad-1000" name="radius" value="1000" class="hidden custom-radio-input">
                        <label for="rad-1000" class="custom-radio-label text-center p-2 border rounded-md cursor-pointer text-sm">1km</label>
                    </div>
                </div>
            </div>

            <!-- Search Button -->
            <button id="perform-search-btn" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-indigo-600 px-4 py-3 text-base font-medium text-white shadow-sm hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                執行搜尋
            </button>
        </div>

        <!-- Middle Column: Results -->
        <div class="w-full md:w-auto md:max-w-sm bg-slate-50 flex flex-col border-r border-gray-200">
            <div class="p-4 border-b border-gray-200 bg-white">
                <div class="flex justify-between items-center">
                     <h2 class="text-lg font-semibold text-gray-800">搜尋結果</h2>
                     <button id="ai-decide-btn" disabled class="text-sm text-indigo-600 font-semibold hover:text-indigo-800 disabled:text-gray-400 disabled:cursor-not-allowed">✨ AI 幫我決定</button>
                </div>
            </div>
            <div id="results-panel" class="flex-1 p-4 overflow-y-auto">
                <div id="ai-recommendation" class="mb-4 p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-500">
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-gray-400 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.12 15.88L12 17l-2.12 1.12a.5.5 0 0 1-.73-.55l.4-2.35-1.7-1.66a.5.5 0 0 1 .28-.85l2.36-.34.01-.01L12 9.5l1.06 2.14.01.01 2.36.34a.5.5 0 0 1 .28.85l-1.7 1.66.4 2.35a.5.5 0 0 1-.73.55z"/></svg>
                        <p>執行搜尋後，AI 將在此為您推薦最棒的選擇！</p>
                    </div>
                </div>
                <div id="status" class="text-sm text-gray-500">請先設定中心點。</div>
                <ul id="results-list" class="space-y-2"></ul>
            </div>
        </div>
    </div>
    
    <!-- Right Column: Map -->
    <div id="map" class="flex-1 h-full"></div>

    <!-- Floating Menu Button for Mobile -->
    <button id="menu-btn" class="md:hidden absolute top-4 left-4 z-10 p-3 bg-white rounded-full shadow-lg text-gray-700 hover:bg-gray-100">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const searchInput = document.getElementById('search-input');
        const searchAddressBtn = document.getElementById('search-address-btn');
        const locateMeBtn = document.getElementById('locate-me-btn');
        const performSearchBtn = document.getElementById('perform-search-btn');
        const statusDiv = document.getElementById('status');
        const resultsList = document.getElementById('results-list');
        const aiRecommendationBox = document.getElementById('ai-recommendation');
        const aiDecideBtn = document.getElementById('ai-decide-btn');
        
        // --- App State ---
        let currentSearchCoords = null;
        let currentPlaces = []; // Will store { data: place, marker: leafletMarker }
        let isAiMode = false; // Flag to check if the list is filtered by AI
        let searchLayer = L.layerGroup();
        let poiLayer = L.layerGroup();
        let radiusCircle = null;
        performSearchBtn.disabled = true;
        
        const categoryQueries = {
            food: '[amenity~"restaurant|fast_food|food_court"]',
            cafe: '[amenity="cafe"]',
            drinks: '[shop~"beverages|tea"]'
        };

        // --- MAP SETUP ---
        const map = L.map('map', { zoomControl: false }).setView([25.0478, 121.5319], 13);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        searchLayer.addTo(map);
        poiLayer.addTo(map);

        const routingControl = L.Routing.control({
            waypoints: [],
            routeWhileDragging: false,
            router: L.Routing.osrmv1({
                serviceUrl: `https://router.project-osrm.org/route/v1`,
                profile: 'foot' // Set to walking mode
            }),
            lineOptions: { styles: [{color: '#0ea5e9', opacity: 0.8, weight: 6, dashArray: '5, 10'}] },
            geocoder: L.Control.Geocoder.nominatim(),
            show: false,
            collapsible: true,
            createMarker: function() { return null; }
        }).addTo(map);
        
        // --- FUNCTIONS ---
        function resetAIBox() {
            aiRecommendationBox.className = 'mb-4 p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-500';
            aiRecommendationBox.innerHTML = `<div class="flex items-start">
                <svg class="w-6 h-6 text-gray-400 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.12 15.88L12 17l-2.12 1.12a.5.5 0 0 1-.73-.55l.4-2.35-1.7-1.66a.5.5 0 0 1 .28-.85l2.36-.34.01-.01L12 9.5l1.06 2.14.01.01 2.36.34a.5.5 0 0 1 .28.85l-1.7 1.66.4 2.35a.5.5 0 0 1-.73.55z"/></svg>
                <p>執行搜尋後，AI 將在此為您推薦最棒的選擇！</p>
            </div>`;
        }

        function clearAllLayers(clearRoute = true) {
            searchLayer.clearLayers();
            poiLayer.clearLayers();
            resultsList.innerHTML = '';
            resetAIBox();
            currentPlaces = [];
            isAiMode = false;
            aiDecideBtn.disabled = true;

            if (radiusCircle) {
                map.removeLayer(radiusCircle);
                radiusCircle = null;
            }
            if (clearRoute) {
               routingControl.setWaypoints([]);
               routingControl.hide();
            }
        }
        
        function setLoadingState(element, text) {
            element.innerHTML = `<div class="flex items-center text-sm text-gray-500"><svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${text}</div>`;
        }

        function setCenterLocation(lat, lon, displayName) {
            clearAllLayers();
            currentSearchCoords = { lat, lon };
            map.flyTo([lat, lon], 16);

            L.marker([lat, lon], {
                draggable: true
            }).on('dragend', function(event) {
                const marker = event.target;
                const position = marker.getLatLng();
                setCenterLocation(position.lat, position.lng, "自訂位置");
            }).addTo(searchLayer).bindPopup(`<b>${displayName}</b><br><small>可拖動此圖釘以微調位置</small>`).openPopup();
            
            statusDiv.textContent = `中心點已設定：${displayName}`;
            performSearchBtn.disabled = false;
        }

        async function searchAddress() {
            const query = searchInput.value;
            if (!query) {
                statusDiv.textContent = '請輸入要搜尋的關鍵字。';
                return;
            }
            setLoadingState(statusDiv, '正在搜尋地址...');
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&accept-language=zh-tw`);
                const data = await response.json();
                if (data && data.length > 0) {
                    const { lat, lon, display_name } = data[0];
                    setCenterLocation(parseFloat(lat), parseFloat(lon), display_name);
                } else {
                    statusDiv.textContent = '找不到符合的地點。';
                }
            } catch (error) {
                console.error('搜尋地址時發生錯誤:', error);
                statusDiv.textContent = '搜尋時發生錯誤。';
            }
        }

        function locateUser() {
            if (!navigator.geolocation) {
                statusDiv.textContent = "您的瀏覽器不支援定位功能。";
                return;
            }
            setLoadingState(statusDiv, '正在取得您的位置...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    setCenterLocation(latitude, longitude, "我的目前位置");
                },
                (error) => {
                    statusDiv.textContent = "無法取得位置，請確認定位權限已開啟。";
                }
            );
        }

        async function performSearch() {
            if (!currentSearchCoords) {
                statusDiv.textContent = '請先設定一個中心點。';
                return;
            }
            setLoadingState(statusDiv, '正在搜尋...');
            isAiMode = false;
            poiLayer.clearLayers();
            currentPlaces = [];
            resultsList.innerHTML = '';
            routingControl.setWaypoints([]);
            routingControl.hide();

            if (radiusCircle) map.removeLayer(radiusCircle);
            const selectedRadius = document.querySelector('input[name="radius"]:checked').value;
            radiusCircle = L.circle([currentSearchCoords.lat, currentSearchCoords.lon], {
                radius: parseInt(selectedRadius), color: '#4f46e5', fillColor: '#4f46e5', fillOpacity: 0.15, weight: 1.5
            }).addTo(map);

            const selectedCategoryValue = document.querySelector('input[name="category"]:checked').value;
            const overpassCategory = categoryQueries[selectedCategoryValue];
            const overpassQuery = `[out:json][timeout:25];(node${overpassCategory}(around:${selectedRadius},${currentSearchCoords.lat},${currentSearchCoords.lon});way${overpassCategory}(around:${selectedRadius},${currentSearchCoords.lat},${currentSearchCoords.lon}););out center;`;
            
            try {
                const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery)}`);
                const data = await response.json();
                let placesData = data.elements.filter(el => el.tags && el.tags.name);
                placesData.sort((a, b) => (parseFloat(b.tags.rating) || 0) - (parseFloat(a.tags.rating) || 0));

                if (placesData.length > 0) {
                    placesData.forEach(place => {
                        const lat = place.lat || place.center.lat;
                        const lon = place.lon || place.center.lon;
                        const name = place.tags.name;
                        const rating = place.tags.rating || '無';
                        const ratingText = isNaN(parseFloat(rating)) ? rating : parseFloat(rating).toFixed(1);
                        const marker = L.marker([lat, lon]).bindPopup(`<b>${name}</b><br>OSM 評分: ${ratingText}`);
                        marker.addTo(poiLayer);
                        currentPlaces.push({ data: place, marker: marker });
                    });
                    
                    aiDecideBtn.disabled = false;
                    statusDiv.textContent = `找到 ${placesData.length} 個結果，點擊可規劃路徑。`;
                    renderResults(currentPlaces);
                    const selectedCategoryLabel = document.querySelector('input[name="category"]:checked + label').textContent;
                    getAIRecommendation(currentPlaces, selectedCategoryLabel);
                } else {
                    aiDecideBtn.disabled = true;
                    statusDiv.textContent = `在指定範圍內找不到符合的店家。`;
                    resetAIBox();
                }
            } catch (error) {
                console.error('執行搜尋時發生錯誤:', error);
                statusDiv.textContent = '搜尋時發生錯誤，請稍後再試。';
                resetAIBox();
            }
        }
        
        function renderResults(placesWithMarkers) {
            resultsList.innerHTML = ''; // Clear previous results before rendering new ones
            placesWithMarkers.forEach((item) => {
                const placeData = item.data;
                const marker = item.marker;
                const lat = placeData.lat || placeData.center.lat;
                const lon = placeData.lon || placeData.center.lon;
                const name = placeData.tags.name;
                const rating = placeData.tags.rating || '無';
                const ratingText = isNaN(parseFloat(rating)) ? rating : parseFloat(rating).toFixed(1);
                
                const li = document.createElement('li');
                li.className = 'p-3 rounded-md hover:bg-slate-100 cursor-pointer border border-gray-200 transition-all';
                li.innerHTML = `<div class="flex justify-between items-center"><p class="font-semibold text-gray-800 truncate pr-2">${name}</p><div class="flex items-center flex-shrink-0"><svg class="w-4 h-4 text-yellow-400 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg><span class="font-bold text-gray-700 text-sm">${ratingText}</span></div></div>`;
                
                li.addEventListener('click', () => {
                    if (currentSearchCoords) {
                        if (isAiMode) {
                            poiLayer.clearLayers();
                            marker.addTo(poiLayer);
                        }
                        routingControl.setWaypoints([L.latLng(currentSearchCoords.lat, currentSearchCoords.lon), L.latLng(lat, lon)]);
                        routingControl.show();
                        map.flyTo([lat, lon], 17);
                        marker.openPopup();

                        if (window.innerWidth < 768) {
                            sidebar.classList.add('-translate-x-full');
                        }
                    }
                });
                resultsList.appendChild(li);
            });
        }
        
        async function callGeminiAPI(systemPrompt, userPrompt, expectJson = false) {
            const apiKey = "AIzaSyBzl00WUqXPYjPV6jMTHCyyDm5qM_aJzFQ"; // <--- 在這裡貼上您的 API 金鑰

            if (!apiKey) {
                throw new Error("API 金鑰未設定。請在程式碼中填入您的 Gemini API 金鑰。");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            if (expectJson) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: { name: { type: "STRING" }, reason: { type: "STRING" } },
                            required: ["name", "reason"]
                        }
                    }
                };
            }
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.json();
                console.error("API Error Response:", errorBody);
                throw new Error(`API 請求失敗，狀態：${response.status}. 錯誤訊息: ${errorBody.error?.message || '未知錯誤'}`);
            }
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        async function getAIRecommendation(placesWithMarkers, category) {
            setLoadingState(aiRecommendationBox, 'AI 正在為您推薦...');
            aiRecommendationBox.className = 'mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg';
            const topPlaces = placesWithMarkers.slice(0, 5).map(p => `- ${p.data.tags.name} (評分: ${p.data.tags.rating || '無'})`).join('\n');
            const systemPrompt = "你是台灣在地的美食嚮導。你的任務是根據使用者提供的店家列表，用熱情友善的語氣，推薦其中一家最棒的店。你的回覆必須是繁體中文，並且非常簡潔。先說一句吸引人的開場白，然後點名店家，最後用一句話說明推薦原因。絕不使用任何 Markdown 格式。";
            const userPrompt = `使用者正在尋找「${category}」，附近的店家有：\n${topPlaces}\n\n請根據以上列表，只推薦一家店並說明原因。`;
            try {
                const recommendationText = await callGeminiAPI(systemPrompt, userPrompt);
                if (recommendationText) {
                    aiRecommendationBox.innerHTML = `<div class="flex items-start"><svg class="w-6 h-6 text-indigo-500 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.12 15.88L12 17l-2.12 1.12a.5.5 0 0 1-.73-.55l.4-2.35-1.7-1.66a.5.5 0 0 1 .28-.85l2.36-.34.01-.01L12 9.5l1.06 2.14.01.01 2.36.34a.5.5 0 0 1 .28.85l-1.7 1.66.4 2.35a.5.5 0 0 1-.73.55z"/></svg><p class="text-sm text-indigo-800">${recommendationText.trim()}</p></div>`;
                } else { resetAIBox(); }
            } catch (error) {
                console.error("AI recommendation error:", error);
                aiRecommendationBox.innerHTML = `<p class="text-sm text-red-600"><strong>AI 推薦失敗：</strong> ${error.message}</p>`;
            }
        }

        async function getAIFiveChoices() {
            if (!currentPlaces || currentPlaces.length === 0) return;
            isAiMode = true; // Set AI mode to true
            setLoadingState(aiRecommendationBox, 'AI 正在為您挑選五家口袋名單...');
            aiRecommendationBox.className = 'mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg';

            const topPlaces = currentPlaces.slice(0, 10).map(p => `- ${p.data.tags.name} (評分: ${p.data.tags.rating || '無'})`).join('\n');
            const category = document.querySelector('input[name="category"]:checked + label').textContent;
            const systemPrompt = "你是台灣在地的嚮導。任務是從一份店家列表中，挑選出 5 家各有特色的店推薦給使用者。每一家都要有不同的推薦理由。你的回覆必須是一個包含 5 個物件的 JSON 陣列。每個物件應包含 'name' (店家名稱字串) 和 'reason' (一句推薦理由字串) 兩個鍵。";
            const userPrompt = `使用者正在尋找「${category}」，請從以下店家列表中，挑選5家並以JSON格式回傳：\n${topPlaces}`;

            try {
                const jsonString = await callGeminiAPI(systemPrompt, userPrompt, true);
                const recommendations = JSON.parse(jsonString);

                if (recommendations && recommendations.length > 0) {
                    const recommendedNames = recommendations.map(r => r.name);
                    const filteredPlaces = currentPlaces.filter(p => recommendedNames.includes(p.data.tags.name));
                    
                    renderResults(filteredPlaces);
                    statusDiv.textContent = '點店家路徑規劃';

                    let recommendationHtml = '<p class="font-semibold text-indigo-800 mb-2">為您挑出了五家口袋名單！</p><ul class="space-y-2">';
                    recommendations.forEach(rec => {
                         recommendationHtml += `<li class="text-sm text-indigo-800"><strong class="text-indigo-700">${rec.name}</strong>：${rec.reason}</li>`;
                    });
                    recommendationHtml += '</ul>';
                    aiRecommendationBox.innerHTML = recommendationHtml;
                } else {
                    aiRecommendationBox.innerHTML = `<p class="text-sm text-red-600">抱歉，AI 目前無法提供建議。</p>`;
                    isAiMode = false;
                }
            } catch (error) {
                console.error("AI 5 choices error:", error);
                aiRecommendationBox.innerHTML = `<p class="text-sm text-red-600"><strong>AI 推薦失敗：</strong> ${error.message}</p>`;
                isAiMode = false;
            }
        }

        // --- EVENT LISTENERS ---
        searchAddressBtn.addEventListener('click', searchAddress);
        searchInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') searchAddress(); });
        locateMeBtn.addEventListener('click', locateUser);
        performSearchBtn.addEventListener('click', performSearch);
        aiDecideBtn.addEventListener('click', getAIFiveChoices);
        
        // Mobile sidebar toggle
        menuBtn.addEventListener('click', () => sidebar.classList.remove('-translate-x-full'));
        closeSidebarBtn.addEventListener('click', () => sidebar.classList.add('-translate-x-full'));
        map.on('click', () => {
             if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
            }
        });

    });
</script>

</body>
</html>


